var fs = require('fs');
var path = require('path');

module.exports = {
    // Install Sandstone inside a Django/Playdoh container
    install_sandstone: {
        run: function(d, v, namedArgs) {
            var projectName = namedArgs.project;

            if(!projectName) {
                console.log('Please specify you project name using the project=name argument');
                return;
            }

            function finished_message() {
                console.log('\nSandstone installed\n');
            }

            v.command('add', 'ossreleasefeed/Sandstone', 'tmp')
                .then(function() {
                    var projectBase = projectName + '/base/',
                        templateDir = projectBase + 'templates/',
                        projectStatic = projectBase + '/static/',
                        lessFileDir = projectStatic + 'css',
                        jsFileDir = projectStatic + 'js',
                        fontFilesDir = projectStatic + 'fonts',
                        imgFilesDir = projectStatic + 'img';

                    // Before copying, we need to manipulate some strings in the files
                    // to ensure they are found and loaded inside it's new home.
                    console.log('Rewriting file contents to fix asset paths...');
                    var lessFileList = fs.readdirSync('tmp/css/sandstone'),
                        tmpLESSPath = 'tmp/css/sandstone/',
                        file = "";

                    for(file in lessFileList) {
                        if(lessFileList.hasOwnProperty(file)) {
                            var currentFile = "",
                                currentFileContents = "",
                                regexp = /\/?\bimg\b|\bfonts\b/g,
                                newSubStr = lessFileList[file] === 'fonts.less' ? '/static/fonts' : '/static/img';
                                processedStr = "";

                            currentFile = tmpLESSPath + lessFileList[file];
                            currentFileContents = fs.readFileSync(currentFile, 'utf-8');

                            processedStr = currentFileContents.replace(regexp, newSubStr);
                            if(lessFileList[file] === 'fonts.less') {
                                console.log(processedStr);
                            }
                        }
                    }

                    console.log('Copying files....');

                    // Copy the LESS files
                    v.copyDir('tmp/css', lessFileDir);

                    // Copy js files
                    v.copyDir('tmp/js', jsFileDir);

                    // Copy fonts
                    v.copyDir('tmp/fonts', fontFilesDir);

                    // Copy images
                    v.copyDir('tmp/img', imgFilesDir);

                    // Copy base template
                    v.copyFile('tmp/base.html', templateDir + 'base.html');

                    // Remove the temporary files
                    v.rm('tmp');

                    finished_message();
                })
                .then(d.resolve, d.reject);
        }
    }
};
